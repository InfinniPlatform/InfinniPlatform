{
  "Id": "e0e02c90-82d1-4e07-a70e-3f65ee17ee27",
  "LayoutPanel": {
    "GridPanel": {
      "Rows": [
        {
          "Cells": [
            {
              "ColumnSpan": 4,
              "Items": [
                {
                  "TreeView": {
                    "KeyProperty": "Id",
                    "ParentProperty": "ParentId",
                    "DisplayProperty": "Text",
                    "Items": {
                      "PropertyBinding": {
                        "DataSource": "MenuObjectDataSource"
                      }
                    }
                  }
                }
              ]
            },
            {
              "ColumnSpan": 8,
              "Items": [
                {
                  "StackPanel": {
                    "Items": [
                      {
                        "Label": {
                          "Text": "Вложенные пункты меню"
                        }
                      },
                      {
                        "DataGrid": {
                          "Columns": [
                            {
                              "Text": "Заголовок",
                              "DisplayProperty": "Text"
                            }
                          ],
                          "Items": {
                            "PropertyBinding": {
                              "DataSource": "SubItemsObjectDataSource"
                            }
                          },
                          "ToolBar": {
                            "Items": [
                              {
                                "ToolBarButton": {
                                  "Text": "Добавить",
                                  "OnClick": {
                                    "Name": "OnAddMenuSubItem"
                                  }
                                }
                              },
                              {
                                "ToolBarButton": {
                                  "Text": "Изменить",
                                  "OnClick": {
                                    "Name": "OnEditMenuSubItem"
                                  }
                                }
                              },
                              {
                                "ToolBarButton": {
                                  "Text": "Удалить",
                                  "OnClick": {
                                    "Name": "OnDeleteMenuSubItem"
                                  }
                                }
                              }
                            ]
                          }
                        }
                      },
                      {
                        "ToolBar": {
                          "Items": [
                            {
                              "ToolBarButton": {
                                "Text": "Добавить",
                                "OnClick": {
                                  "Name": "OnAddMenuSubItem"
                                }
                              }
                            },
                            {
                              "ToolBarButton": {
                                "Text": "Изменить",
                                "OnClick": {
                                  "Name": "OnEditMenuSubItem"
                                }
                              }
                            },
                            {
                              "ToolBarButton": {
                                "Text": "Удалить",
                                "OnClick": {
                                  "Name": "OnDeleteMenuSubItem"
                                }
                              }
                            }
                          ]
                        }
                      },
                      {
                        "Label": {
                          "Text": "Роли, имеющие права на выбранный пункт"
                        }
                      },
                      {
                        "DataGrid": {
                          "Columns": [
                            {
                              "Text": "Заголовок",
                              "DisplayProperty": "Role.Name"
                            }
                          ],
                          "Items": {
                            "PropertyBinding": {
                              "DataSource": "SubItemRolesDataSource"
                            }
                          },
                          "ToolBar": {
                            "Items": [
                              {
                                "ToolBarButton": {
                                  "Text": "Добавить",
                                  "OnClick": {
                                    "Name": "OnAddRoleMenuSubItem"
                                  }
                                }
                              },
                              {
                                "ToolBarButton": {
                                  "Text": "Удалить",
                                  "OnClick": {
                                    "Name": "OnDeleteRoleMenuSubItem"
                                  }
                                }
                              }
                            ]
                          }
                        }
                      },
                      {
                        "ToolBar": {
                          "Items": [
                            {
                              "ToolBarButton": {
                                "Text": "Добавить",
                                "OnClick": {
                                  "Name": "OnAddRoleMenuSubItem"
                                }
                              }
                            },
                            {
                              "ToolBarButton": {
                                "Text": "Удалить",
                                "OnClick": {
                                  "Name": "OnDeleteRoleMenuSubItem"
                                }
                              }
                            }
                          ]
                        }
                      }
                    ]
                  }
                }
              ]
            }
          ]
        }
      ]
    }
  },
  "OnLoaded": {
    "Name": "OnLoadedHandler"
  },
  "Scripts": [
    {
      "Name": "OnLoadedHandler",
      "Body": "context.Global.executeAction({\r\n\t\tSaveAction: {\r\n\t\t\tDataSource: 'MenuDocumentDataSource',\r\n\t\t\tCanClose: false\r\n\t\t}\r\n\t},\r\n\tfunction(data) {\r\n\t\tcontext.DataSources['MenuObjectDataSource'].setDataItems(data);\r\n\t\tcontext.DataSources['SubItemRolesDataSource'].setDataItems([]);\r\n\t}\r\n);"
    },
    {
      "Name": "OnSelectMenuItem",
      "Body": "debugger;\r\nvar selectedItem = context.DataSources['MenuObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem !== null && selectedItem !== undefined && _.isArray(selectedItem) === false) {\r\n\tcontext.DataSources['SubItemsDocumentDataSource'].setSelectedItem(selectedItem);\r\n\r\n\tcontext.Global.executeAction({\r\n\t\t\tSaveAction: {\r\n\t\t\t\tDataSource: 'SubItemsDocumentDataSource',\r\n\t\t\t\tCanClose: false\r\n\t\t\t}\r\n\t\t},\r\n\t\tfunction(data) {\r\n\t\t\tcontext.DataSources['SubItemsObjectDataSource'].setSelectedItem(null);\r\n\t\t\tcontext.DataSources['SubItemsObjectDataSource'].setDataItems(data);\r\n\t\t}\r\n\t);\r\n\r\n\tcontext.DataSources['SubItemRolesDataSource'].setDataItems([]);\r\n}"
    },
    {
      "Name": "OnAddMenuSubItem",
      "Body": "var selectedItem = context.DataSources['MenuObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem !== null && selectedItem !== undefined && _.isArray(selectedItem) === false) {\r\n\tcontext.Parameters['EditItem'].setValue(null);\r\n\t\r\n\tcontext.Global.executeAction({\r\n\t\t\tAddAction: {\r\n\t\t\t\tView: {\r\n\t\t\t\t\tAutoView: {\r\n\t\t\t\t\t\tConfigId: \"Administration\",\r\n\t\t\t\t\t\tDocumentId: \"Menu\",\r\n\t\t\t\t\t\tViewType: \"EditView\",\r\n\t\t\t\t\t\tOpenMode: \"Dialog\"\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tDataSource: 'SubItemsObjectDataSource'\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n}"
    },
    {
      "Name": "OnEditMenuSubItem",
      "Body": "var selectedItem = context.DataSources['SubItemsObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem !== null && selectedItem !== undefined && _.isArray(selectedItem) === false) {\r\n\tcontext.Parameters['EditItem'].setValue(selectedItem);\r\n\t\r\n\tcontext.Global.executeAction({\r\n\t\t\tAddAction: {\r\n\t\t\t\tView: {\r\n\t\t\t\t\tAutoView: {\r\n\t\t\t\t\t\tConfigId: \"Administration\",\r\n\t\t\t\t\t\tDocumentId: \"Menu\",\r\n\t\t\t\t\t\tViewType: \"EditView\",\r\n\t\t\t\t\t\tOpenMode: \"Dialog\"\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\tDataSource: 'SubItemsObjectDataSource'\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n}"
    },
    {
      "Name": "OnDeleteMenuSubItem",
      "Body": "var selectedItem = context.DataSources['SubItemsObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem !== null && selectedItem !== undefined && _.isArray(selectedItem) === false) {\r\n\tcontext.DataSources['DeleteMenuDocumentDataSource'].setSelectedItem(selectedItem);\r\n\r\n\tcontext.Global.executeAction({\r\n\t\t\tSaveAction: {\r\n\t\t\t\tDataSource: 'DeleteMenuDocumentDataSource',\r\n\t\t\t\tCanClose: false\r\n\t\t\t}\r\n\t\t},\r\n\t\tfunction(isDeleted) {\r\n\t\t\tif (isDeleted === true) {\r\n\t\t\t\tcontext.Scripts['OnSelectMenuItem'].Run(context, null);\r\n\t\t\t\tcontext.Scripts['OnLoadedHandler'].Run(context, null);\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n}"
    },
    {
      "Name": "OnSelectMenuSubItem",
      "Body": "var selectedItem = context.DataSources['SubItemsObjectDataSource'].getSelectedItem();\r\n\r\nvar rolesDataSource = context.DataSources['SubItemRolesDataSource'];\r\n\r\nif(selectedItem) {\r\n\t\r\n\tvar criteria = new Criteria(); \r\n\tcriteria.setItems([ {Property: 'MenuItemId', Value: selectedItem.Id, CriteriaType: 1} ]); \r\n\trolesDataSource.setQueryFilter(criteria); \r\n\trolesDataSource.resumeUpdate();\r\n\t\r\n}\r\nelse {\r\n\r\n\tvar criteria = new Criteria(); \r\n\tcriteria.setItems([ {Property: 'MenuItemId', Value: '111111', CriteriaType: 1} ]); \r\n\trolesDataSource.setQueryFilter(criteria); \r\n\trolesDataSource.resumeUpdate();\r\n\r\n}"
    },
    {
      "Name": "OnAddRoleMenuSubItem",
      "Body": "var selectedItem = context.DataSources['SubItemsObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem) {\r\n    \r\n\tcontext.Parameters['EditItem'].setValue(selectedItem);\t\r\n\tcontext.Global.executeAction({\r\n\t\t\tOpenViewAction: {\r\n\t\t\t\tView: {\r\n\t\t\t\t\tAutoView: {\r\n\t\t\t\t\t\tConfigId: \"Administration\",\r\n\t\t\t\t\t\tDocumentId: \"MenuItemSettings\",\r\n\t\t\t\t\t\tMetadataName: \"EditViewMenuItem\",\r\n\t\t\t\t\t\tOpenMode: \"Dialog\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t);\r\n}"
    },
    {
      "Name": "OnDeleteRoleMenuSubItem",
      "Body": "\r\nvar selectedItem = context.DataSources['SubItemsObjectDataSource'].getSelectedItem();\r\n\r\nif (selectedItem) {\r\n\t\r\n\tvar selectedRole = context.DataSources['SubItemRolesDataSource'].getSelectedItem();\r\n\r\n\tif(selectedRole) {\r\n\t   \r\n\t    context.DataSources['DeleteRoleMenuDocumentDataSource'].setSelectedItem(selectedRole);\r\n\t    context.Global.executeAction({\r\n\t\t\t\t\t\tDeleteAction: {\r\n\t\t\t\t\t\t\tDataSource: 'DeleteRoleMenuDocumentDataSource'\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}, function(data) {\r\n\t\t\t\t\t   setTimeout(context.DataSources['SubItemRolesDataSource'].resumeUpdate(),400);\r\n\t\t\t\t\t});\r\n\t}\r\n\t\r\n\treturn;\r\n\r\n\tif (selectedRole !== null && selectedRole !== undefined && _.isArray(selectedRole) === false) {\r\n\t\tif (selectedItem.Roles !== null && selectedItem.Roles !== undefined) {\r\n\t\t\tvar selectedRoleIndex = selectedItem.Roles.indexOf(selectedRole);\r\n\r\n\t\t\tif (selectedRoleIndex >= 0) {\r\n\t\t\t\tvar editItem = JSON.parse(JSON.stringify(selectedItem));\r\n\t\t\t\teditItem.Roles.splice(selectedRoleIndex, 1);\r\n\r\n\t\t\t\tcontext.DataSources['DeleteRoleMenuDocumentDataSource'].setSelectedItem(editItem);\r\n\r\n\t\t\t\tcontext.Global.executeAction({\r\n\t\t\t\t\t\tSaveAction: {\r\n\t\t\t\t\t\t\tDataSource: 'DeleteRoleMenuDocumentDataSource',\r\n\t\t\t\t\t\t\tCanClose: false\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\tfunction(isDeleted) {\r\n\t\t\t\t\t\tif (isDeleted === true) {\r\n\t\t\t\t\t\t\tcontext.Scripts['OnSelectMenuItem'].Run(context, null);\r\n\t\t\t\t\t\t\tcontext.Scripts['OnLoadedHandler'].Run(context, null);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t);\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}"
    }
  ],
  "DataSources": [
    {
      "DocumentDataSource": {
        "Name": "MenuDocumentDataSource",
        "ConfigId": "Administration",
        "DocumentId": "Menu",
        "UpdateAction": "GetMenu"
      }
    },
    {
      "ObjectDataSource": {
        "Name": "MenuObjectDataSource",
        "OnSelectedItemChanged": {
          "Name": "OnSelectMenuItem"
        }
      }
    },
    {
      "DocumentDataSource": {
        "Name": "SubItemsDocumentDataSource",
        "ConfigId": "Administration",
        "DocumentId": "Menu",
        "UpdateAction": "GetMenu"
      }
    },
    {
      "ObjectDataSource": {
        "Name": "SubItemsObjectDataSource",
        "OnSelectedItemChanged": {
          "Name": "OnSelectMenuSubItem"
        }
      }
    },
    {
      "DocumentDataSource": {
        "Name": "DeleteMenuDocumentDataSource",
        "ConfigId": "Administration",
        "DocumentId": "Menu",
        "UpdateAction": "DeleteMenu"
      }
    },
    {
      "DocumentDataSource": {
        "Name": "DeleteRoleMenuDocumentDataSource",
        "ConfigId": "Administration",
        "DocumentId": "MenuItemSettings"
      }
    },
    {
      "DocumentDataSource": {
        "Name": "SubItemRolesDataSource",
        "ConfigId": "Administration",
        "DocumentId": "MenuItemSettings",
        "PageSize": 10000,
        "Query": [
          {
            "Property": "Id",
            "Value": "11111",
            "CriteriaType": 1
          }
        ]
      }
    }
  ],
  "Parameters": [
    {
      "Name": "EditItem"
    }
  ],
  "__DocumentId": "viewmetadata",
  "__ConfigId": "systemconfig",
  "ParentId": "d2da06bc-80c7-40a9-b882-6276210eb229",
  "Name": "ListView",
  "Caption": "Настройка главного меню",
  "Description": "",
  "MetadataType": "ListView",
  "Text": "Настройка главного меню"
}
