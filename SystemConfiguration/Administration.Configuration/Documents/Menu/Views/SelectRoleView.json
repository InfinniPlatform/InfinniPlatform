{
  "Id": "dfd91967-5031-46f2-9776-4179920f2626",
  "MetadataType": "SelectView",
  "Description": "",
  "Caption": "Роли пользователя",
  "Name": "SelectRoleView",
  "ParentId": "d2da06bc-80c7-40a9-b882-6276210eb229",
  "Version": "version_systemconfig",
  "__ConfigId": "systemconfig",
  "__DocumentId": "viewmetadata",
  "Text": "Роли пользователя",
  "Scripts": [
    {
      "Name": "OnLoadedSelectRoleViewHandler",
      "Body": "var parentView = context.ParentView.getParentView();\r\nvar editItem = parentView.getParameter('EditItem').getValue();\r\n\r\nif (editItem === null || editItem === undefined) {\r\n\tvar parentItem = parentView.getDataSource('MenuObjectDataSource').getSelectedItem();\r\n\r\n\teditItem = {\r\n\t\tParentId: parentItem.Id,\r\n\t\tConfigId: parentItem.ConfigId,\r\n\t\tMenuId: parentItem.MenuId,\r\n\t\tLevel: parentItem.Level + 1\r\n\t};\r\n}\r\n\r\neditItem = JSON.parse(JSON.stringify(editItem));\r\ncontext.DataSources['MainDataSource'].setDataItems([ editItem ]);\r\ncontext.DataSources['MainDataSource'].setSelectedItem(editItem);"
    },
    {
      "Name": "OnAddRoleHandler",
      "Body": "var selectedRole = context.Controls['SelectedRoleElement'].getValue();\r\n\r\nif (selectedRole !== null && selectedRole !== undefined && _.isArray(selectedRole) === false) {\r\n\tvar editItem = context.DataSources['MainDataSource'].getSelectedItem();\r\n\r\n\tif (editItem.Roles === null || editItem.Roles === undefined) {\r\n\t\teditItem.Roles = [ selectedRole.Id ];\r\n\t}\r\n\telse {\r\n\t\teditItem.Roles.push(selectedRole.Id);\r\n\t}\r\n\r\n\tcontext.DataSources['MainDataSource'].setSelectedItem(editItem);\r\n\r\n\tcontext.Global.executeAction({\r\n\t\t\tSaveAction: {\r\n\t\t\t\tDataSource: 'MainDataSource',\r\n\t\t\t\tCanClose: false\r\n\t\t\t}\r\n\t\t},\r\n\t\tfunction(isUpdated) {\r\n\t\t\tvar parentView = context.ParentView.getParentView();\r\n\r\n\t\t\tif (isUpdated === true) {\r\n\t\t\t\tvar parentContext = parentView.getContext();\r\n\r\n\t\t\t\tvar onRefreshSubItems = parentContext.Scripts['OnSelectMenuItem'];\r\n\t\t\t\tonRefreshSubItems.Run(parentContext, null);\r\n\r\n\t\t\t\tvar onRefreshMenu = parentContext.Scripts['OnLoadedHandler'];\r\n\t\t\t\tonRefreshMenu.Run(parentContext, null);\r\n\t\t\t}\r\n\r\n\t\t\tcontext.ParentView.close();\r\n\t\t}\r\n\t);\r\n}"
    }
  ],
  "DataSources": [
    {
      "DocumentDataSource": {
        "Name": "MainDataSource",
        "ConfigId": "Administration",
        "DocumentId": "Menu",
        "UpdateAction": "SaveMenu"
      }
    },
    {
      "ObjectDataSource": {
        "Name": "RolesDataSource",
        "Items": [
          {
            "Id": "Administrator",
            "DisplayName": "Администратор"
          },
          {
            "Id": "MedicalWorker",
            "DisplayName": "Медицинский работник"
          }
        ]
      }
    }
  ],
  "OnLoaded": {
    "Name": "OnLoadedSelectRoleViewHandler"
  },
  "LayoutPanel": {
    "StackPanel": {
      "Items": [
        {
          "ComboBox": {
            "Name": "SelectedRoleElement",
            "DisplayProperty": "DisplayName",
            "Value": {
              "PropertyBinding": {
                "DataSource": "SelectedRoleDataSource",
                "Property": "Value"
              }
            },
            "Items": {
              "PropertyBinding": {
                "DataSource": "RolesDataSource"
              }
            }
          }
        },
        {
          "ToolBar": {
            "Items": [
              {
                "ToolBarButton": {
                  "Text": "OK",
                  "OnClick": {
                    "Name": "OnAddRoleHandler"
                  }
                }
              },
              {
                "ToolBarButton": {
                  "Text": "Отмена",
                  "Action": {
                    "CancelAction": {}
                  }
                }
              }
            ]
          }
        }
      ]
    }
  }
}
