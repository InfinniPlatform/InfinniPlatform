{
  "Id": "28dcddb2-6467-4124-b3d2-39655f2fcfc1",
  "Scripts": [
    {
      "Name": "CreateOrUpdatePermissionsAndEdit",
      "Body": "\r\nvar selectedItem = context.DataSources['MainDataSource'].getSelectedItem();\r\n\r\nif(selectedItem && selectedItem.SectionSelected && selectedItem.Role) {\r\n\r\n   var criteria = new Criteria();\r\n   criteria.items = [ \r\n     { CriteriaType: 1, Property: 'Section.Id', Value: selectedItem.SectionSelected.Id }, \r\n     { CriteriaType: 1, Property: 'Role.Id', Value: selectedItem.Role.Id },\r\n   ];\r\n  \r\n   var selectedDataSource = context.DataSources['SelectedItemDataSource'];\r\n   selectedDataSource.setQueryFilter(criteria);\r\n    \r\n}\r\nelse {\r\n\tnew MessageBox({\r\n        text: 'Необходимо указать Роль и Раздел',\r\n        buttons: [\r\n            {\r\n\t\t\t\t\tname: 'ОК'             \t\t\t       \r\n            }\r\n        ]\r\n     })\r\n}"
    },
    {
      "Name": "SelectedDataSourceUpdated",
      "Body": "\r\nvar functionSave = function(data) {\r\n\r\n\tcontext.Global.executeAction({\r\n\t   SaveAction : {\r\n\t      DataSource : 'EditingItemDataSource',\r\n\t      CanClose : false\r\n\t   }\r\n\t}, function(data) {\r\n\t\r\n\t\tcontext.Global.executeAction({\r\n\t\t   EditAction : {\r\n\t\t      View : {\r\n\t\t        AutoView : {\r\n\t\t           ConfigId : 'Administration',\r\n\t\t           DocumentId : 'RolePermissions',\r\n\t\t           MetadataName : 'EditViewRolePermission',\r\n\t\t           OpenMode : 'Dialog'\r\n\t\t        }\r\n\t\t      },\r\n\t\t      DataSource : 'EditingItemDataSource'      \r\n\t\t   }\r\n\t\t})    \r\n\t})\r\n}\r\n\r\nif(!context.DataSources['MainDataSource'].getSelectedItem() || !context.DataSources['MainDataSource'].getSelectedItem().SectionSelected) {\r\n return\r\n}\r\n\r\nvar items = context.DataSources['SelectedItemDataSource'].getDataItems();\r\n\r\n\r\nif(items.length > 0) {\r\n    \r\n    context.DataSources['EditingItemDataSource'].setSelectedItem(items[0]);\r\n    var selectedItem = items[0];\r\n}\r\nelse {\r\n    var selectedItem = context.DataSources['MainDataSource'].getSelectedItem();\r\n    var itemToCreate = {};\r\n    itemToCreate.Id = guid();\r\n\titemToCreate.Section = selectedItem.SectionSelected; \r\n    itemToCreate.Role = selectedItem.Role;\r\n    itemToCreate.Organization = selectedItem.Organization;    \r\n    context.DataSources['EditingItemDataSource'].setSelectedItem(itemToCreate);\r\n}\r\n\r\nfunctionSave(null);\r\n\r\n\r\n\r\n  \r\n\r\n"
    },
    {
      "Name": "SetMainDataSourceSelectedItem",
      "Body": "context.DataSources['MainDataSource'].setSelectedItem({});"
    },
    {
      "Name": "RoleChanged",
      "Body": "var selectedItem = context.DataSources['MainDataSource'].getSelectedItem(); \r\nif(selectedItem) {\r\n\r\n  var selectedRole = selectedItem.Role;\r\n  if(selectedRole)  {  \r\n    var permissionsDataSource = context.DataSources['PermissionsDataSource'];\r\n    var criteria = new Criteria();   \r\n    criteria.items = [ { CriteriaType: 1, Property: 'Role.Id', Value: selectedRole.Id } ];   \r\n    permissionsDataSource.setQueryFilter(criteria);   \r\n  }\r\n}"
    }
  ],
  "__DocumentId": "viewmetadata",
  "__ConfigId": "systemconfig",
  "Version": "version_systemconfig",
  "ParentId": "cf4d2816-9dde-4143-8e53-1bcaa1972bcf",
  "Name": "EditView",
  "Caption": "Форма редактирования прав доступа роли",
  "Description": "",
  "MetadataType": "EditView",
  "Text": "Права доступа для роли",
  "OnLoaded": {
    "Name": "SetMainDataSourceSelectedItem"
  },
  "ChildViews": [],
  "DataSources": [
    {
      "DocumentDataSource": {
        "Name": "MainDataSource",
        "ConfigId": "Administration",
        "DocumentId": "RolePermissions",
        "PageSize": 1000
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "Role",
        "Name": "RoleDataSource",
        "PageSize": 1000
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "User",
        "Name": "UserDataSource",
        "PageSize": 1000
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "RolePermissions",
        "Name": "PermissionsDataSource",
        "PageSize": 1000,
        "Query": [
          {
            "Property": "Id",
            "Value": "11111",
            "CriteriaType": 1
          }
        ]
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "Section",
        "Name": "SectionDataSource",
        "PageSize": 1000
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "RolePermissions",
        "Name": "SelectedItemDataSource",
        "OnItemsUpdated": {
          "Name": "SelectedDataSourceUpdated"
        }
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "RolePermissions",
        "Name": "EditingItemDataSource"
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "RolePermissions",
        "Name": "DenyDataSource",
        "UpdateAction": "DenySection"
      }
    },
    {
      "DocumentDataSource": {
        "ConfigId": "Administration",
        "DocumentId": "User",
        "Name": "AddUserRoleDataSource",
        "UpdateAction": "AddUserRole"
      }
    }
  ],
  "LayoutPanel": {
    "StackPanel": {
      "Items": [
        {
          "ScrollPanel": {
            "LayoutPanel": {
              "GridPanel": {
                "Rows": [
                  {
                    "Cells": [
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "Label": {
                              "Name": "RoleLabel",
                              "Text": "Роль"
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "ComboBox": {
                              "Name": "RoleComboBox",
                              "ValueProperty": "Id",
                              "DisplayProperty": "Name",
                              "Value": {
                                "PropertyBinding": {
                                  "DataSource": "MainDataSource",
                                  "Property": "Role"
                                }
                              },
                              "OnValueChanged": {
                                "Name": "RoleChanged"
                              },
                              "Items": {
                                "PropertyBinding": {
                                  "DataSource": "RoleDataSource"
                                }
                              }
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "Label": {
                              "Text": "Раздел"
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "ComboBox": {
                              "ValueProperty": "Id",
                              "DisplayProperty": "Name",
                              "Value": {
                                "PropertyBinding": {
                                  "DataSource": "MainDataSource",
                                  "Property": "SectionSelected"
                                }
                              },
                              "Items": {
                                "PropertyBinding": {
                                  "DataSource": "SectionDataSource"
                                }
                              }
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "Button": {
                              "Text": "Назначить права на действия в разделе",
                              "OnClick": {
                                "Name": "CreateOrUpdatePermissionsAndEdit"
                              }
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 12,
                        "Items": [
                          {
                            "Label": {
                              "Text": ""
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 3,
                        "Items": [
                          {
                            "Label": {
                              "Text": "Разделы, на которые установлены права доступа"
                            }
                          }
                        ]
                      },
                      {
                        "ColumnSpan": 9,
                        "Items": [
                          {
                            "DataGrid": {
                              "Columns": [
                                {
                                  "Text": "Наименование раздела",
                                  "DisplayProperty": "Section.DisplayName"
                                },
                                {
                                  "Text": "Разрешение на создание",
                                  "DisplayProperty": "PermissionCreate"
                                },
                                {
                                  "Text": "Разрешение на просмотр",
                                  "DisplayProperty": "PermissionRead"
                                },
                                {
                                  "Text": "Разрешение на исправление",
                                  "DisplayProperty": "PermissionUpdate"
                                },
                                {
                                  "Text": "Разрешение на удаление",
                                  "DisplayProperty": "PermissionDelete"
                                }
                              ],
                              "Items": {
                                "PropertyBinding": {
                                  "DataSource": "PermissionsDataSource"
                                }
                              }
                            }
                          }
                        ]
                      }
                    ]
                  }
                ]
              }
            }
          }
        }
      ]
    }
  }
}
