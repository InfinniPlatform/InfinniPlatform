<?xml version="1.0" encoding="utf-8"?>
<Project ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

	<PropertyGroup>
		<_CommonProgramFiles>$([System.Environment]::GetEnvironmentVariable('CommonProgramFiles(x86)'))</_CommonProgramFiles>
		<_CommonProgramFiles Condition=" '$(_CommonProgramFiles)' == '' ">$(CommonProgramFiles)</_CommonProgramFiles>
		<TextTransformPath Condition="'$(TextTransformPath)' == ''">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\$(VisualStudioVersion)\TextTransform.exe</TextTransformPath>
		<!-- Initial default value -->
		<_TransformExe>$(TextTransformPath)</_TransformExe>
		<!-- Cascading probing if file not found -->
		<_TransformExe Condition="!Exists('$(_TransformExe)')">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\10.0\TextTransform.exe</_TransformExe>
		<_TransformExe Condition="!Exists('$(_TransformExe)')">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\11.0\TextTransform.exe</_TransformExe>
		<_TransformExe Condition="!Exists('$(_TransformExe)')">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\12.0\TextTransform.exe</_TransformExe>
		<!-- Future proof 'til VS2013+2 -->
		<_TransformExe Condition="!Exists('$(_TransformExe)')">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\13.0\TextTransform.exe</_TransformExe>
		<_TransformExe Condition="!Exists('$(_TransformExe)')">$(_CommonProgramFiles)\Microsoft Shared\TextTemplating\14.0\TextTransform.exe</_TransformExe>
	</PropertyGroup>

	<Target Name="TransformOnBuild" AfterTargets="BeforeBuild">

		<Warning Text="Failed to find TextTransform.exe tool at '$(_TransformExe)."
                Condition="!Exists('$(_TransformExe)')"/>

		<ItemGroup>
			<_TextTransform Include="@(None)"
                            Condition="'%(None.Generator)' == 'TextTemplatingFileGenerator' And Exists('$(_TransformExe)')" />
		</ItemGroup>

		<!-- Perform task batching for each file -->
		<Exec Command="&quot;$(_TransformExe)&quot; &quot;%(_TextTransform.FullPath)&quot;"
              Condition="'%(_TextTransform.Identity)' != '' And Exists('$(_TransformExe)')"/>

	</Target>

</Project>